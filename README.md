# Сервис назначения ревьюеров для Pull Request'ов (Стажировка Осень 2025 в Авито)

Микросервис для автоматического назначения ревьюеров на Pull Request'ы, управления командами и участниками

## Описание

Сервис автоматически назначает ревьюеров на PR из команды автора, позволяет выполнять переназначение ревьюверов и получать список PR'ов, назначенных конкретному пользователю, а также управлять командами и активностью пользователей.

## Технологический стек

- **Язык**: Go 1.24+
- **База данных**: PostgreSQL 15
- **HTTP сервер**: стандартная библиотека net/http
- **k6** для нагрузочного тестирования
- **golangci-lint** для статического анализа

### Основные возможности

- **Автоматическое назначение ревьюеров**: При создании PR автоматически назначаются до двух активных ревьюверов из команды автора
- **Переназначение ревьюверов**: Замена одного ревьювера на случайного активного участника из команды заменяемого ревьювера
- **Управление командами**: Создание команд и управление участниками
- **Управление активностью пользователей**: Активация/деактивация пользователей
- **Статистика**: Получение статистики по назначениям, PR и командам
- **Массовая деактивация**: Безопасная деактивация пользователей команды с автоматическим переназначением открытых PR

## Установка и запуск

### Быстрый старт с Docker Compose

Самый простой способ запустить сервис:

```bash
make docker-run
```

Или напрямую:

```bash
docker-compose up -d --build
```

Или локально:
```bash
make run
```

- Сервис будет доступен на `http://localhost:8080`
- Swagger будет доступне на `http://localhost:8080/swagger/`
- Миграции применяются автоматически при запуске сервиса.
- Для упрощения в рамках тестового задания .env файл уже есть

## Использование Makefile

Проект включает Makefile с удобными командами:

### Основные команды

```bash
make build

# Запуск сервиса локально
make run

# Сборка Docker образа
make docker-build

# Запуск через Docker Compose
make docker-run

# Остановка и очистка
make clean

# Запуск E2E тестов
make e2e-test

# Запуск нагрузочного тестирования
make k6-run

# Установка линтера
make install-lint

# Запуск линтера
make lint
```

## Структура проекта

```
.
├── api/                   
│   ├── openapi.yml       
│   └── swagger/           
├── cmd/
│   └── app/
│       └── main.go        
├── internal/             
│   ├── config/           
│   ├── entity/
│   ├── handler/          
│   ├── repository/       
│   ├── service/          
│   └── utils/            
├── migrations/           
│   ├── 000001_init.up.sql
│   └── 000001_init.down.sql
├── pkg/                  
│   └── db/               
├── tests/                
│   ├── e2e-testing/     
│   └── load-testing/    
├── docker-compose.yml   
├── Dockerfile           
├── Makefile             
├── .golangci.yml        
└── README.md           
```

## Основные эндпоинты

#### Команды

- `POST /team/add` - Создание команды
- `GET /team/get?team_name={name}` - Получение информации о команде
- `POST /team/deactivate` - Массовая деактивация пользователей команды

#### Пользователи

- `POST /users/setIsActive` - Изменение активности пользователя
- `GET /users/getReview?user_id={id}` - Получение списка PR для ревью

#### Pull Request'ы

- `POST /pullRequest/create` - Создание PR с автоматическим назначением ревьюеров
- `POST /pullRequest/merge` - Слияние PR (идемпотентная операция)
- `POST /pullRequest/reassign` - Переназначение ревьювера

#### Статистика

- `GET /stats/summary` - Получение общей статистики

#### Health Check

- `GET /health` - Проверка работоспособности сервиса

## Выполненные задачи

### Основной функционал:

✅ **REST API** - все эндпоинты реализованы согласно OpenAPI спецификации в `api/openapi.yml`

**Архитектура приложения** - применён подход чистой архитектуры с выделением отдельных слоёв

**База данных PostgreSQL** - все данные хранятся в PostgreSQL, схема управляется через автоматические миграции (golang-migrate)

### Дополнительные функции:

**Эндпоинт статистики**: Реализован эндпоинт `GET /stats/summary`, который возвращает детальную статистику по системе:
   - Количество назначений ревьюеров по каждому пользователю
   - Статистика по статусам PR (открытые, слиянные, среднее количество ревьюеров)
   - Информация о составе команд (активные и неактивные участники)
   - Метрики времени жизни PR (среднее время до слияния, количество открытых PR старше 7 дней)

**E2E тестирование**

**Нагрузочное тестирование** - реализованы тесты производительности с использованием k6:

**Сценарии:**
- Создание PR: 5 RPS, длительность 2 минуты
- Получение команды: 3 RPS, длительность 2 минуты

**Результаты:**
- **Время ответа**: среднее 1.38 мс, медиана 1.73 мс, p95 2.31 мс, максимум 33.27 мс
- **Пропускная способность**: 8.01 запросов/сек
- **Успешность проверок**: 100% 

**Конфигурация линтера** - настроен golangci-lint в `.golangci.yml`:

**Логирование** - реализовано с использованием стандартного пакета `log/slog`

**Массовая деактивация пользователей**: Реализован эндпоинт `POST /team/deactivate` для безопасной деактивации нескольких пользователей команды одновременно:
   - Автоматически выполняется переназначение ревьюверов для всех открытых PR, где деактивируемые пользователи были назначены
   - Возвращается детальный отчёт об успешных и неудачных переназначениях
   - Если для какого-то PR нет доступных кандидатов для замены, это фиксируется в ответе, но не блокирует деактивацию других пользователей


## Допущения

**Отсутствие авторизации**: В задании не было требований к системе аутентификации и авторизации, поэтому API доступен без проверки прав доступа

